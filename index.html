<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Облако слов</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden; /* чтобы не было полос прокрутки */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #e5e7eb 45%, #dbeafe 100%);
      color: #0f172a;
      position: relative;
    }

    /* Облако на весь экран, без рамок и карточек */

    #wordcloud {
      position: absolute;
      inset: 0;     /* top:0; right:0; bottom:0; left:0 */
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Статус обновления — аккуратно внизу слева */

    .status {
      position: fixed;
      left: 14px;
      bottom: 10px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
    }

    .status.error .dot {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
    }

    .status span:last-child {
      color: #e5e7eb;
    }

    /* QR внизу справа */

    .qr-card {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 10px 12px 14px;
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: center;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
      z-index: 20;
    }

    .qr-card:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 24px 45px rgba(15, 23, 42, 1);
    }

    .qr-card img {
      display: block;
      width: 160px;
      height: 160px;
      border-radius: 14px;
      background: #ffffff;
    }

    .qr-title {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
      color: #e5e7eb;
      max-width: 190px;
      line-height: 1.3;
    }

    /* Тултип для слов */

    .wc-tooltip {
      position: fixed;
      z-index: 50;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      opacity: 0;
      transition: opacity 0.12s ease-out;
    }

    .wc-tooltip.visible {
      opacity: 1;
    }

    /* Модалка для большого QR */

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .qr-modal.active {
      display: flex;
    }

    .qr-modal-inner {
      text-align: center;
    }

    .qr-modal-img {
      max-width: 80vmin;
      max-height: 80vmin;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.95);
    }

    .qr-modal-caption {
      margin-top: 12px;
      font-size: 14px;
      color: #e5e7eb;
    }

    .qr-modal-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .qr-card {
        right: 12px;
        bottom: 12px;
      }

      .qr-card img {
        width: 130px;
        height: 130px;
      }

      .status {
        left: 10px;
        bottom: 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Облако на весь экран -->
  <section id="wordcloud"></section>

  <!-- Статус обновления -->
  <div id="status" class="status">
    <span class="dot"></span>
    <span>Обновление данных…</span>
  </div>

  <!-- Один QR к форме, только для сканирования + зум по клику -->
  <div class="qr-card"
       data-title="Перейти к форме и написать 3 слова"
       data-large-src="https://api.qrserver.com/v1/create-qr-code/?size=480x480&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader">
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader"
      alt="QR: перейти к форме">
    <div class="qr-title">Перейти к форме и написать 3 слова</div>
  </div>

  <!-- Тултип для слов -->
  <div id="wc-tooltip" class="wc-tooltip"></div>

  <!-- Модальное окно большого QR -->
  <div id="qr-modal" class="qr-modal">
    <div class="qr-modal-inner">
      <img id="qr-modal-img" class="qr-modal-img" src="" alt="">
      <div id="qr-modal-caption" class="qr-modal-caption"></div>
      <div class="qr-modal-hint">Нажмите в любом месте, чтобы закрыть</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
  <script>
    const csvUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0Jo7s9n49D_HbgL9LQvSJ8qxkS0rVq1oV7lmkAyC8eDiUj2WSYcrAmyrB74ZNDscLSFW2mnAWQ-XI/pub?output=csv';

    let isFetching = false;
    let lastEntries = [];
    let lastMaxCount = 1;

    const statusEl = document.getElementById('status');
    const tooltipEl = document.getElementById('wc-tooltip');

    const qrModal = document.getElementById('qr-modal');
    const qrModalImg = document.getElementById('qr-modal-img');
    const qrModalCaption = document.getElementById('qr-modal-caption');

    // Зум QR по клику (без перехода по ссылке)
    function initQrZoom() {
      const card = document.querySelector('.qr-card');
      if (!card) return;

      card.addEventListener('click', () => {
        const largeSrc = card.getAttribute('data-large-src');
        const title = card.getAttribute('data-title') || '';
        if (!largeSrc) return;

        qrModalImg.src = largeSrc;
        qrModalCaption.textContent = title;
        qrModal.classList.add('active');
      });

      qrModal.addEventListener('click', () => {
        qrModal.classList.remove('active');
      });
    }

    // CSV парсер с кавычками
    function parseCsvLine(line) {
      const result = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    }

    function cleanField(value) {
      if (!value) return '';
      let word = value.trim();

      if (word.startsWith('"') && word.endsWith('"')) {
        word = word.slice(1, -1);
      }

      word = word.replace(/[«»„“”"']/g, '');

      return word.trim();
    }

    async function fetchWords() {
      if (isFetching) return;
      isFetching = true;

      if (statusEl) {
        statusEl.classList.remove('error');
        statusEl.querySelector('span:last-child').textContent = 'Обновление данных…';
      }

      try {
        const response = await fetch(csvUrl + '&cacheBust=' + Date.now());
        const text = await response.text();

        const lines = text.trim().split('\n');
        const dataLines = lines.length > 1 ? lines.slice(1) : lines;

        const rows = dataLines
          .map(line => parseCsvLine(line))
          .filter(cols => cols.length > 1);

        generateWordCloud(rows);

        if (statusEl) {
          statusEl.classList.remove('error');
          statusEl.querySelector('span:last-child').textContent =
            'Последнее обновление: ' + new Date().toLocaleTimeString();
        }
      } catch (error) {
        console.error('Ошибка при загрузке данных:', error);
        if (statusEl) {
          statusEl.classList.add('error');
          statusEl.querySelector('span:last-child').textContent =
            'Ошибка загрузки данных. Проверьте доступ к таблице.';
        }
      } finally {
        isFetching = false;
      }
    }

    // Берём до трёх слов: B, C, D
    function generateWordCloud(rows) {
      if (!rows || !rows.length) {
        console.warn('Нет строк с данными');
        return;
      }

      const counts = {};
      const display = {};

      rows.forEach(cols => {
        [1, 2, 3].forEach(idx => {
          if (idx >= cols.length) return;

          const field = cleanField(cols[idx]);
          if (!field) return;

          const pieces = field.split(/[,\s/|]+/).filter(Boolean);

          pieces.forEach(piece => {
            let normalized = piece
              .toLowerCase()
              .replace(/[.,!?;:()]/g, '')
              .trim();

            if (!normalized) return;

            if (!counts[normalized]) {
              counts[normalized] = 0;
              display[normalized] = piece.trim();
            }
            counts[normalized]++;
          });
        });
      });

      const entries = Object.keys(counts).map(key => ({
        word: display[key],
        count: counts[key]
      }));

      if (!entries.length) {
        console.warn('Не получилось собрать слова');
        return;
      }

      entries.sort((a, b) => b.count - a.count || a.word.localeCompare(b.word, 'ru'));

      lastEntries = entries;
      lastMaxCount = entries[0].count || 1;

      renderWordCloud();
    }

    // Облако на весь экран
    function renderWordCloud() {
      const el = document.getElementById('wordcloud');
      if (!el || !lastEntries.length) return;

      const list = lastEntries.map(e => [e.word, e.count]);
      const maxCount = lastMaxCount || 1;

      console.log('Уникальных слов в облаке:', list.length);

      WordCloud(el, {
        list,
        gridSize: 8, // компактнее — больше слов влезает
        weightFactor: function (size) {
          const min = 10;
          const max = 42;
          return min + (size / maxCount) * (max - min);
        },
        fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        color: function () {
          const palette = [
            '#1d4ed8',
            '#0f766e',
            '#7c3aed',
            '#be123c',
            '#ea580c',
            '#16a34a'
          ];
          return palette[Math.floor(Math.random() * palette.length)];
        },
        rotateRatio: 0.06,
        rotationSteps: 4,
        backgroundColor: 'rgba(255,255,255,0)',
        shuffle: true,
        drawOutOfBound: false,
        shrinkToFit: true,
        clearCanvas: true,
        hover: function (item, dimension, event) {
          if (!tooltipEl) return;

          if (!item) {
            tooltipEl.classList.remove('visible');
            return;
          }

          const word = item[0];
          const count = item[1];

          tooltipEl.textContent = word + ' — ' + count + ' раз(а)';
          tooltipEl.style.left = event.clientX + 'px';
          tooltipEl.style.top = event.clientY + 'px';
          tooltipEl.classList.add('visible');
        }
      });
    }

    initQrZoom();
    fetchWords();
    setInterval(fetchWords, 10000);

    window.addEventListener('resize', () => {
      renderWordCloud();
    });
  </script>
</body>
</html>
