<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û–±–ª–∞–∫–æ —Å–ª–æ–≤</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #e5e7eb 45%, #dbeafe 100%);
      color: #0f172a;
      position: relative;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ —Å–æ —Å–ª–æ–≤–∞–º–∏ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    #wordcloud {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –º–∞–ª–µ–Ω—å–∫–∏–π —á–∏–ø –≤–Ω–∏–∑—É —Å–ª–µ–≤–∞ */
    .status {
      position: fixed;
      left: 14px;
      bottom: 10px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
      z-index: 30;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
    }

    .status.error .dot {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
    }

    .status span:last-child {
      color: #e5e7eb;
    }

    /* QR –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞ */
    .qr-card {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 10px 12px 14px;
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: center;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
      z-index: 20;
    }

    .qr-card:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 24px 45px rgba(15, 23, 42, 1);
    }

    .qr-card img {
      display: block;
      width: 160px;
      height: 160px;
      border-radius: 14px;
      background: #ffffff;
    }

    .qr-title {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
      color: #e5e7eb;
      max-width: 190px;
      line-height: 1.3;
    }

    /* –¢—É–ª—Ç–∏–ø –ø–æ —Å–ª–æ–≤–∞–º */
    .wc-tooltip {
      position: fixed;
      z-index: 50;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      opacity: 0;
      transition: opacity 0.12s ease-out;
    }

    .wc-tooltip.visible {
      opacity: 1;
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –±–æ–ª—å—à–æ–≥–æ QR */
    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .qr-modal.active {
      display: flex;
    }

    .qr-modal-inner {
      text-align: center;
    }

    .qr-modal-img {
      max-width: 80vmin;
      max-height: 80vmin;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.95);
    }

    .qr-modal-caption {
      margin-top: 12px;
      font-size: 14px;
      color: #e5e7eb;
    }

    .qr-modal-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .qr-card {
        right: 12px;
        bottom: 12px;
      }

      .qr-card img {
        width: 130px;
        height: 130px;
      }

      .status {
        left: 10px;
        bottom: 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–≤–∞—Å–∞ —Å–æ —Å–ª–æ–≤–∞–º–∏ -->
  <div id="wordcloud"></div>

  <!-- –°—Ç–∞—Ç—É—Å -->
  <div id="status" class="status">
    <span class="dot"></span>
    <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</span>
  </div>

  <!-- –û–¥–∏–Ω QR —Å–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞, —Ç–æ–ª—å–∫–æ –∑—É–º –ø–æ –∫–ª–∏–∫—É -->
  <div class="qr-card"
       data-title="–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–æ—Ä–º–µ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å 3 —Å–ª–æ–≤–∞"
       data-large-src="https://api.qrserver.com/v1/create-qr-code/?size=480x480&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader">
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader"
      alt="QR: –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–æ—Ä–º–µ">
    <div class="qr-title">–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–æ—Ä–º–µ –∏ –Ω–∞–ø–∏—Å–∞—Ç—å 3 —Å–ª–æ–≤–∞</div>
  </div>

  <!-- –¢—É–ª—Ç–∏–ø -->
  <div id="wc-tooltip" class="wc-tooltip"></div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±–æ–ª—å—à–æ–≥–æ QR -->
  <div id="qr-modal" class="qr-modal">
    <div class="qr-modal-inner">
      <img id="qr-modal-img" class="qr-modal-img" src="" alt="">
      <div id="qr-modal-caption" class="qr-modal-caption"></div>
      <div class="qr-modal-hint">–ù–∞–∂–º–∏—Ç–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å</div>
    </div>
  </div>


  <script>
  const csvUrl =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0Jo7s9n49D_HbgL9LQvSJ8qxkS0rVq1oV7lmkAyC8eDiUj2WSYcrAmyrB74ZNDscLSFW2mnAWQ-XI/pub?output=csv';

  let isFetching = false;

  // üëá –≤–º–µ—Å—Ç–æ lastEntries/lastMaxCount
  let occurrences = [];    // —Å–ø–∏—Å–æ–∫ –í–°–ï–• –ø–æ—è–≤–ª–µ–Ω–∏–π —Å–ª–æ–≤
  let wordStats = {};      // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–º —Å–ª–æ–≤–∞–º { key: { word, count } }
  let globalMaxCount = 1;  // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —Å–ª–æ–≤

  let drawnWords = []; // —Å—é–¥–∞ –∑–∞–ø–∏—à–µ–º, —á—Ç–æ –∏ –∫—É–¥–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª–∏

  const statusEl = document.getElementById('status');
  const tooltipEl = document.getElementById('wc-tooltip');

  const qrModal = document.getElementById('qr-modal');
  const qrModalImg = document.getElementById('qr-modal-img');
  const qrModalCaption = document.getElementById('qr-modal-caption');

  // ====== –ó–£–ú QR –ü–û –ö–õ–ò–ö–£ ======
  function initQrZoom() {
    const card = document.querySelector('.qr-card');
    if (!card) return;

    card.addEventListener('click', () => {
      const largeSrc = card.getAttribute('data-large-src');
      const title = card.getAttribute('data-title') || '';
      if (!largeSrc) return;

      qrModalImg.src = largeSrc;
      qrModalCaption.textContent = title;
      qrModal.classList.add('active');
    });

    qrModal.addEventListener('click', () => {
      qrModal.classList.remove('active');
    });
  }

  // ====== CSV –ü–ê–†–°–ï–† ======
  function parseCsvLine(line) {
    const result = [];
    let cur = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        result.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    result.push(cur);
    return result;
  }

  function cleanField(value) {
    if (!value) return '';
    let word = value.trim();

    if (word.startsWith('"') && word.endsWith('"')) {
      word = word.slice(1, -1);
    }

    word = word.replace(/[¬´¬ª‚Äû‚Äú‚Äù"']/g, '');

    return word.trim();
  }

  // ====== –ó–ê–ì–†–£–ó–ö–ê CSV ======
  async function fetchWords() {
    if (isFetching) return;
    isFetching = true;

    if (statusEl) {
      statusEl.classList.remove('error');
      statusEl.querySelector('span:last-child').textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö‚Ä¶';
    }

    try {
      const response = await fetch(csvUrl + '&cacheBust=' + Date.now());
      const text = await response.text();

      const lines = text.trim().split('\n');
      const dataLines = lines.length > 1 ? lines.slice(1) : lines;

      const rows = dataLines
        .map(line => parseCsvLine(line))
        .filter(cols => cols.length > 1);

      generateWordList(rows);

      if (statusEl) {
        statusEl.classList.remove('error');
        statusEl.querySelector('span:last-child').textContent =
          '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + new Date().toLocaleTimeString();
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
      if (statusEl) {
        statusEl.classList.add('error');
        statusEl.querySelector('span:last-child').textContent =
          '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ.';
      }
    } finally {
      isFetching = false;
    }
  }

  // ====== –°–û–ë–ò–†–ê–ï–ú –í–°–ï –í–•–û–ñ–î–ï–ù–ò–Ø –°–õ–û–í (B, C, D) ======
  function generateWordList(rows) {
    if (!rows || !rows.length) {
      console.warn('–ù–µ—Ç —Å—Ç—Ä–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏');
      return;
    }

    const stats = {};   // —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞
    const occs = [];    // –∫–∞–∂–¥–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ

    rows.forEach(cols => {
      [1, 2, 3].forEach(idx => {
        if (idx >= cols.length) return;

        const field = cleanField(cols[idx]);
        if (!field) return;

        const pieces = field.split(/[,\s/|]+/).filter(Boolean);

        pieces.forEach(piece => {
          let normalized = piece
            .toLowerCase()
            .replace(/[.,!?;:()]/g, '')
            .trim();

          if (!normalized) return;

          if (!stats[normalized]) {
            stats[normalized] = {
              word: piece.trim(),
              count: 0
            };
          }

          // —Å—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
          stats[normalized].count++;

          // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –∫–∞–∂–¥–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ
          occs.push({
            key: normalized,
            word: piece.trim()
          });
        });
      });
    });

    if (!occs.length) {
      console.warn('–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å —Å–ª–æ–≤–∞');
      return;
    }

    // –Ω–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —á–∞—Å—Ç–æ—Ç—É
    let maxCount = 1;
    Object.keys(stats).forEach(key => {
      if (stats[key].count > maxCount) {
        maxCount = stats[key].count;
      }
    });

    // –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã ‚Äî —Å–Ω–∞—á–∞–ª–∞ –º–µ–ª–∫–∏–µ, –ø–æ—Ç–æ–º –∫—Ä—É–ø–Ω—ã–µ (–∫—Ä—É–ø–Ω—ã–µ —Å–≤–µ—Ä—Ö—É)
    occs.sort((a, b) => {
      const ca = stats[a.key].count;
      const cb = stats[b.key].count;
      if (ca === cb) {
        return a.word.localeCompare(b.word, 'ru');
      }
      return ca - cb;
    });

    occurrences = occs;
    wordStats = stats;
    globalMaxCount = maxCount;

    renderWordCloud();
  }

  // ====== –†–ò–°–£–ï–ú –ö–ê–ñ–î–û–ï –í–•–û–ñ–î–ï–ù–ò–ï –°–õ–û–í–ê ======
  function renderWordCloud() {
    const container = document.getElementById('wordcloud');
    if (!container || !occurrences.length) return;

    let canvas = container.querySelector('canvas');
    if (!canvas) {
      canvas = document.createElement('canvas');
      container.innerHTML = '';
      container.appendChild(canvas);
    }

    const rect = container.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, rect.width, rect.height);

    const maxCount = globalMaxCount || 1;
    const minSize = 16;
    const maxSize = 64;
    const margin = 20;

    const palette = [
      '#1d4ed8',
      '#0f766e',
      '#7c3aed',
      '#be123c',
      '#ea580c',
      '#16a34a'
    ];

    drawnWords = [];

    occurrences.forEach(entry => {
      const stats = wordStats[entry.key];
      const text = entry.word;
      const count = stats ? stats.count : 1;

      const size = minSize + (count / maxCount) * (maxSize - minSize);

      ctx.font = `${size}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
      ctx.textBaseline = 'alphabetic';

      const metrics = ctx.measureText(text);
      const textWidth = metrics.width;
      const textHeight = size;

      const maxX = Math.max(margin, rect.width - textWidth - margin);
      const maxY = Math.max(margin + textHeight, rect.height - margin);

      const x = margin + Math.random() * (maxX - margin);
      const y = margin + textHeight + Math.random() * (maxY - (margin + textHeight));

      ctx.fillStyle = palette[Math.floor(Math.random() * palette.length)];
      ctx.fillText(text, x, y);

      drawnWords.push({
        word: text,
        count,
        x,
        y,
        width: textWidth,
        height: textHeight
      });
    });

    console.log('–ù–∞—Ä–∏—Å–æ–≤–∞–Ω–æ —Å–ª–æ–≤ (–≤–∫–ª—é—á–∞—è –≤—Å–µ –ø–æ–≤—Ç–æ—Ä—ã):', drawnWords.length);
  }

  // ====== –•–û–í–ï–† –ü–û –°–õ–û–í–ê–ú (–ø—Ä–∏–º–µ—Ä–Ω–æ, –ø–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫—É) ======
  function initWordHover() {
    const container = document.getElementById('wordcloud');
    if (!container) return;

    container.addEventListener('mousemove', (e) => {
      if (!tooltipEl || !drawnWords.length) return;

      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      let hit = null;
      // –∏–¥—ë–º —Å –∫–æ–Ω—Ü–∞ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ —Å—á–∏—Ç–∞–µ–º ¬´–≤–µ—Ä—Ö–Ω–∏–º–∏¬ª
      for (let i = drawnWords.length - 1; i >= 0; i--) {
        const w = drawnWords[i];
        if (
          x >= w.x &&
          x <= w.x + w.width &&
          y <= w.y &&
          y >= w.y - w.height
        ) {
          hit = w;
          break;
        }
      }

      if (!hit) {
        tooltipEl.classList.remove('visible');
        return;
      }

      tooltipEl.textContent = `${hit.word} ‚Äî ${hit.count} —Ä–∞–∑(–∞)`;
      tooltipEl.style.left = e.clientX + 'px';
      tooltipEl.style.top = e.clientY + 'px';
      tooltipEl.classList.add('visible');
    });

    container.addEventListener('mouseleave', () => {
      if (tooltipEl) tooltipEl.classList.remove('visible');
    });
  }

  // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
  initQrZoom();
  initWordHover();
  fetchWords();
  setInterval(fetchWords, 10000);

  window.addEventListener('resize', () => {
    renderWordCloud();
  });
</script>

</body>
</html>

