<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Облако слов</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #e5e7eb 45%, #dbeafe 100%);
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: #0f172a;
    }

    /* Два блока на один экран: слева облако, справа QR */

    .root {
      width: 100%;
      max-width: 1440px;
      height: 100vh;
      padding: 24px 32px;
      display: flex;
      gap: 24px;
    }

    .main {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 24px;
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.55);
      backdrop-filter: blur(12px);
      padding: 18px 22px 12px;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 0 4px 8px;
    }

    h1 {
      margin: 0 0 4px;
      font-size: 28px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      color: #111827;
    }

    .subtitle {
      margin: 0;
      font-size: 14px;
      color: #6b7280;
    }

    #wordcloud {
      flex: 1;
      min-height: 0;
      margin-top: 10px;
      border-radius: 18px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background:
        radial-gradient(circle at 8% 0%, #f9fafb 0, #e5e7eb 35%, #e0f2fe 100%);
      overflow: hidden;
      position: relative;
    }

    .status {
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 4px 2px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .status.error .dot {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2);
    }

    /* Правая узкая колонка с QR */

    .qr-side {
      width: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 12px 14px 16px;
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: center;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
    }

    .qr-card:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 24px 45px rgba(15, 23, 42, 1);
    }

    .qr-card a {
      text-decoration: none;
      color: inherit;
      display: inline-block;
    }

    .qr-card img {
      display: block;
      width: 150px;
      height: 150px;
      border-radius: 14px;
      background: #ffffff;
    }

    .qr-title {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      color: #e5e7eb;
      max-width: 180px;
      line-height: 1.3;
    }

    /* Тултип для слов */

    .wc-tooltip {
      position: fixed;
      z-index: 50;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      opacity: 0;
      transition: opacity 0.12s ease-out;
    }

    .wc-tooltip.visible {
      opacity: 1;
    }

    /* Модальное окно с увеличенным QR */

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .qr-modal.active {
      display: flex;
    }

    .qr-modal-inner {
      text-align: center;
    }

    .qr-modal-img {
      max-width: 80vmin;
      max-height: 80vmin;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.95);
    }

    .qr-modal-caption {
      margin-top: 12px;
      font-size: 14px;
      color: #e5e7eb;
    }

    .qr-modal-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    /* Адаптив для маленьких экранов */

    @media (max-width: 900px) {
      .root {
        padding: 12px 10px;
        flex-direction: column;
        gap: 12px;
      }

      .qr-side {
        width: 100%;
        order: -1;
      }

      .main {
        height: calc(100vh - 230px);
        border-radius: 18px;
        padding: 12px 12px 8px;
      }

      h1 {
        font-size: 22px;
      }

      #wordcloud {
        border-radius: 14px;
      }

      .qr-card img {
        width: 130px;
        height: 130px;
      }
    }
  </style>
</head>
<body>
  <div class="root">
    <!-- Левая часть: заголовок + облако слов -->
    <main class="main">
      <header class="header">
        <h1>Облако слов</h1>
        <p class="subtitle">
          Живое облако по ответам участников. Обновляется каждые 10&nbsp;секунд.
        </p>
      </header>

      <section id="wordcloud"></section>

      <div id="status" class="status">
        <span class="dot"></span>
        <span>Обновление каждые 10 секунд…</span>
      </div>
    </main>

    <!-- Правая часть: только QR к форме -->
    <aside class="qr-side">
      <div class="qr-card"
           data-title="Ответить на форму (3 слова)"
           data-large-src="https://api.qrserver.com/v1/create-qr-code/?size=420x420&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader">
        <a href="https://docs.google.com/forms/d/e/1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg/viewform?usp=header"
           target="_blank" rel="noopener noreferrer">
          <img
            src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader"
            alt="QR: перейти к форме">
        </a>
        <div class="qr-title">Перейти к форме и написать 3 слова</div>
      </div>
    </aside>
  </div>

  <!-- Тултип для подсказки по словам -->
  <div id="wc-tooltip" class="wc-tooltip"></div>

  <!-- Модальное окно для увеличенного QR -->
  <div id="qr-modal" class="qr-modal">
    <div class="qr-modal-inner">
      <img id="qr-modal-img" class="qr-modal-img" src="" alt="">
      <div id="qr-modal-caption" class="qr-modal-caption"></div>
      <div class="qr-modal-hint">Нажмите в любом месте, чтобы закрыть</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
  <script>
    // ====== ССЫЛКА НА CSV И СОСТОЯНИЕ ======
    const csvUrl =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vR0Jo7s9n49D_HbgL9LQvSJ8qxkS0rVq1oV7lmkAyC8eDiUj2WSYcrAmyrB74ZNDscLSFW2mnAWQ-XI/pub?output=csv';

    let isFetching = false;
    let lastEntries = [];
    let lastMaxCount = 1;

    const statusEl = document.getElementById('status');
    const tooltipEl = document.getElementById('wc-tooltip');

    const qrModal = document.getElementById('qr-modal');
    const qrModalImg = document.getElementById('qr-modal-img');
    const qrModalCaption = document.getElementById('qr-modal-caption');

    // ====== ЗУМ QR КОДА ======
    function initQrZoom() {
      document.querySelectorAll('.qr-card').forEach(card => {
        card.addEventListener('click', (e) => {
          // Если клик прямо по <a> — даём открыть ссылку
          if (e.target.tagName.toLowerCase() === 'a') return;

          const largeSrc = card.getAttribute('data-large-src');
          const title = card.getAttribute('data-title') || '';

          if (!largeSrc) return;

          qrModalImg.src = largeSrc;
          qrModalCaption.textContent = title;
          qrModal.classList.add('active');
        });
      });

      qrModal.addEventListener('click', () => {
        qrModal.classList.remove('active');
      });
    }

    // ====== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ CSV ======
    function parseCsvLine(line) {
      const result = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const ch = line[i];

        if (ch === '"') {
          if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    }

    function cleanField(value) {
      if (!value) return '';
      let word = value.trim();

      if (word.startsWith('"') && word.endsWith('"')) {
        word = word.slice(1, -1);
      }

      word = word.replace(/[«»„“”"']/g, '');

      return word.trim();
    }

    // ====== ЗАГРУЗКА ТЕКСТА И ПОСТРОЕНИЕ ЧАСТОТ ======
    async function fetchWords() {
      if (isFetching) return;
      isFetching = true;

      if (statusEl) {
        statusEl.classList.remove('error');
        statusEl.querySelector('span:last-child').textContent = 'Обновление данных...';
      }

      try {
        const response = await fetch(csvUrl + '&cacheBust=' + Date.now());
        const text = await response.text();

        const lines = text.trim().split('\n');
        const dataLines = lines.length > 1 ? lines.slice(1) : lines;

        const rows = dataLines
          .map(line => parseCsvLine(line))
          .filter(cols => cols.length > 1);

        generateWordCloud(rows);

        if (statusEl) {
          statusEl.classList.remove('error');
          statusEl.querySelector('span:last-child').textContent =
            'Последнее обновление: ' + new Date().toLocaleTimeString();
        }
      } catch (error) {
        console.error('Ошибка при загрузке данных:', error);
        if (statusEl) {
          statusEl.classList.add('error');
          statusEl.querySelector('span:last-child').textContent =
            'Ошибка загрузки данных. Проверьте доступ к таблице.';
        }
      } finally {
        isFetching = false;
      }
    }

    // Берём до трёх слов из строки: столбцы B, C, D
    function generateWordCloud(rows) {
      if (!rows || !rows.length) {
        console.warn('Нет строк с данными');
        return;
      }

      const counts = {};
      const display = {};

      rows.forEach(cols => {
        [1, 2, 3].forEach(idx => {
          if (idx >= cols.length) return;

          const field = cleanField(cols[idx]);
          if (!field) return;

          const pieces = field.split(/[,\s/|]+/).filter(Boolean);

          pieces.forEach(piece => {
            let normalized = piece
              .toLowerCase()
              .replace(/[.,!?;:()]/g, '')
              .trim();

            if (!normalized) return;

            if (!counts[normalized]) {
              counts[normalized] = 0;
              display[normalized] = piece.trim();
            }
            counts[normalized]++;
          });
        });
      });

      const entries = Object.keys(counts).map(key => ({
        word: display[key],
        count: counts[key]
      }));

      if (!entries.length) {
        console.warn('Не получилось собрать слова');
        return;
      }

      entries.sort((a, b) => b.count - a.count || a.word.localeCompare(b.word, 'ru'));

      lastEntries = entries;
      lastMaxCount = entries[0].count || 1;

      renderWordCloud();
    }

    // ====== РЕНДЕР ОБЛАКА ======
    function renderWordCloud() {
      const el = document.getElementById('wordcloud');
      if (!el || !lastEntries.length) return;

      const list = lastEntries.map(e => [e.word, e.count]);
      const maxCount = lastMaxCount || 1;

      WordCloud(el, {
        list,
        gridSize: Math.max(8, Math.round(14 * window.innerWidth / 1024)),
        weightFactor: function (size) {
          const min = 14;
          const max = 64;
          return min + (size / maxCount) * (max - min);
        },
        fontFamily: 'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        color: function () {
          const palette = [
            '#1d4ed8',
            '#0f766e',
            '#7c3aed',
            '#be123c',
            '#ea580c',
            '#16a34a'
          ];
          return palette[Math.floor(Math.random() * palette.length)];
        },
        rotateRatio: 0.06,
        rotationSteps: 4,
        backgroundColor: 'rgba(255,255,255,0)',
        shuffle: true,
        drawOutOfBound: false,
        shrinkToFit: true,
        hover: function (item, dimension, event) {
          if (!tooltipEl) return;

          if (!item) {
            tooltipEl.classList.remove('visible');
            return;
          }

          const word = item[0];
          const count = item[1];

          tooltipEl.textContent = word + ' — ' + count + ' раз(а)';
          tooltipEl.style.left = event.clientX + 'px';
          tooltipEl.style.top = event.clientY + 'px';
          tooltipEl.classList.add('visible');
        }
      });
    }

    // ====== ИНИЦИАЛИЗАЦИЯ ======
    initQrZoom();
    fetchWords();
    setInterval(fetchWords, 10000);

    window.addEventListener('resize', () => {
      renderWordCloud();
    });
  </script>
</body>
</html>
