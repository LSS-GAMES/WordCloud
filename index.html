<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Облако слов</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #e5e7eb 45%, #dbeafe 100%);
      color: #0f172a;
      position: relative;
    }

    /* Контейнер для канваса со словами на весь экран */
    #wordcloud {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    /* Статус обновления — маленький чип внизу слева */
    .status {
      position: fixed;
      left: 14px;
      bottom: 10px;
      font-size: 12px;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.5);
      backdrop-filter: blur(8px);
      z-index: 30;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.3);
    }

    .status.error .dot {
      background: #ef4444;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
    }

    .status span:last-child {
      color: #e5e7eb;
    }

    /* QR внизу справа */
    .qr-card {
      position: fixed;
      right: 24px;
      bottom: 24px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 10px 12px 14px;
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transform-origin: center;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out;
      z-index: 20;
    }

    .qr-card:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 24px 45px rgba(15, 23, 42, 1);
    }

    .qr-card img {
      display: block;
      width: 160px;
      height: 160px;
      border-radius: 14px;
      background: #ffffff;
    }

    .qr-title {
      margin-top: 8px;
      font-size: 13px;
      text-align: center;
      color: #e5e7eb;
      max-width: 190px;
      line-height: 1.3;
    }

    /* Тултип по словам */
    .wc-tooltip {
      position: fixed;
      z-index: 50;
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.96);
      color: #f9fafb;
      font-size: 12px;
      pointer-events: none;
      white-space: nowrap;
      transform: translate(-50%, -120%);
      opacity: 0;
      transition: opacity 0.12s ease-out;
    }

    .wc-tooltip.visible {
      opacity: 1;
    }

    /* Модалка большого QR */
    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.88);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .qr-modal.active {
      display: flex;
    }

    .qr-modal-inner {
      text-align: center;
    }

    .qr-modal-img {
      max-width: 80vmin;
      max-height: 80vmin;
      border-radius: 18px;
      background: #ffffff;
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.95);
    }

    .qr-modal-caption {
      margin-top: 12px;
      font-size: 14px;
      color: #e5e7eb;
    }

    .qr-modal-hint {
      margin-top: 4px;
      font-size: 11px;
      color: #9ca3af;
    }

    @media (max-width: 640px) {
      .qr-card {
        right: 12px;
        bottom: 12px;
      }

      .qr-card img {
        width: 130px;
        height: 130px;
      }

      .status {
        left: 10px;
        bottom: 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Контейнер для канваса со словами -->
  <div id="wordcloud"></div>

  <!-- Статус -->
  <div id="status" class="status">
    <span class="dot"></span>
    <span>Обновление данных…</span>
  </div>

  <!-- Один QR снизу справа, только зум по клику -->
  <div class="qr-card"
       data-title="Перейти к форме и написать 3 слова"
       data-large-src="https://api.qrserver.com/v1/create-qr-code/?size=480x480&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader">
    <img
      src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Fdocs.google.com%2Fforms%2Fd%2Fe%2F1FAIpQLSe98Dyuj49voeLLojNRuwoGXSD9bDCEn7R0QhyAwDJMrufkXg%2Fviewform%3Fusp%3Dheader"
      alt="QR: перейти к форме">
    <div class="qr-title">Перейти к форме и написать 3 слова</div>
  </div>

  <!-- Тултип -->
  <div id="wc-tooltip" class="wc-tooltip"></div>

  <!-- Модальное окно большого QR -->
  <div id="qr-modal" class="qr-modal">
    <div class="qr-modal-inner">
      <img id="qr-modal-img" class="qr-modal-img" src="" alt="">
      <div id="qr-modal-caption" class="qr-modal-caption"></div>
      <div class="qr-modal-hint">Нажмите в любом месте, чтобы закрыть</div>
    </div>
  </div>

<script>
const csvUrl =
  'https://docs.google.com/spreadsheets/d/1hr9ZijIgkMPKR4RLPT4J4WznfQCLI2NPrNCT0bfPmog/export?format=csv&gid=1741986703';


  let isFetching = false;

  // список ВСЕХ появлений (каждая ячейка B/C/D = одно появление)
  let occurrences = [];
  // статистика по уникальным фразам
  let wordStats = {};
  let globalMaxCount = 1;

  let drawnWords = [];

  const statusEl = document.getElementById('status');
  const tooltipEl = document.getElementById('wc-tooltip');

  const qrModal = document.getElementById('qr-modal');
  const qrModalImg = document.getElementById('qr-modal-img');
  const qrModalCaption = document.getElementById('qr-modal-caption');

  // ====== ЗУМ QR ПО КЛИКУ ======
  function initQrZoom() {
    const card = document.querySelector('.qr-card');
    if (!card) return;

    card.addEventListener('click', () => {
      const largeSrc = card.getAttribute('data-large-src');
      const title = card.getAttribute('data-title') || '';
      if (!largeSrc) return;

      qrModalImg.src = largeSrc;
      qrModalCaption.textContent = title;
      qrModal.classList.add('active');
    });

    qrModal.addEventListener('click', () => {
      qrModal.classList.remove('active');
    });
  }

  // ====== CSV ПАРСЕР ======
  function parseCsvLine(line) {
    const result = [];
    let cur = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        result.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    result.push(cur);
    return result;
  }

  function cleanField(value) {
    if (!value) return '';
    let word = value.trim();

    if (word.startsWith('"') && word.endsWith('"')) {
      word = word.slice(1, -1);
    }

    word = word.replace(/[«»„“”"']/g, '');

    return word.trim();
  }

  // ====== ЗАГРУЗКА CSV ======
  async function fetchWords() {
    if (isFetching) return;
    isFetching = true;

    if (statusEl) {
      statusEl.classList.remove('error');
      statusEl.querySelector('span:last-child').textContent = 'Обновление данных…';
    }

    try {
      const response = await fetch(csvUrl + '&cacheBust=' + Date.now());
      const text = await response.text();

      const lines = text.trim().split('\n');
      const dataLines = lines.length > 1 ? lines.slice(1) : lines;

      const rows = dataLines
        .map(line => parseCsvLine(line))
        .filter(cols => cols.length > 1);

      generateWordList(rows);

      if (statusEl) {
        statusEl.classList.remove('error');
        statusEl.querySelector('span:last-child').textContent =
          'Последнее обновление: ' + new Date().toLocaleTimeString();
      }
    } catch (error) {
      console.error('Ошибка при загрузке данных:', error);
      if (statusEl) {
        statusEl.classList.add('error');
        statusEl.querySelector('span:last-child').textContent =
          'Ошибка загрузки данных. Проверьте доступ к таблице.';
      }
    } finally {
      isFetching = false;
    }
  }

  // ====== СОБИРАЕМ ВСЕ ВХОЖДЕНИЯ СЛОВ/ФРАЗ ИЗ B, C, D ======
  function generateWordList(rows) {
    if (!rows || !rows.length) {
      console.warn('Нет строк с данными');
      return;
    }

    const stats = {};   // уникальные фразы
    const occs = [];    // каждое появление

    rows.forEach(cols => {
      [1, 2, 3].forEach(idx => {
        if (idx >= cols.length) return;

        const field = cleanField(cols[idx]);
        if (!field) return;

        // одна ячейка = одно "слово/фраза"
        const pieces = [field];

        pieces.forEach(piece => {
          let normalized = piece
            .toLowerCase()
            .replace(/[.,!?;:()]/g, '')
            .trim();

          if (!normalized) return;

          if (!stats[normalized]) {
            stats[normalized] = {
              word: piece.trim(),
              count: 0
            };
          }

          // считаем общее количество вхождений этой фразы
          stats[normalized].count++;

          // сохраняем КАЖДОЕ вхождение
          occs.push({
            key: normalized,
            word: piece.trim()
          });
        });
      });
    });

    if (!occs.length) {
      console.warn('Не получилось собрать слова');
      return;
    }

    // находим максимальную частоту
    let maxCount = 1;
    Object.keys(stats).forEach(key => {
      if (stats[key].count > maxCount) {
        maxCount = stats[key].count;
      }
    });

    console.log(
      'Строк в CSV:', rows.length,
      'Уникальных фраз:', Object.keys(stats).length,
      'Всего вхождений (occurrences):', occs.length
    );

    // сначала менее частые, крупные сверху
    occs.sort((a, b) => {
      const ca = stats[a.key].count;
      const cb = stats[b.key].count;
      if (ca === cb) {
        return a.word.localeCompare(b.word, 'ru');
      }
      return ca - cb;
    });

    occurrences = occs;
    wordStats = stats;
    globalMaxCount = maxCount;

    renderWordCloud();
  }

  // ====== РИСУЕМ КАЖДОЕ ВХОЖДЕНИЕ (ЦЕНТР + МОЖНО ПЕРЕКРЫВАТЬСЯ) ======
  function renderWordCloud() {
    const container = document.getElementById('wordcloud');
    if (!container || !occurrences.length) return;

    let canvas = container.querySelector('canvas');
    if (!canvas) {
      canvas = document.createElement('canvas');
      container.innerHTML = '';
      container.appendChild(canvas);
    }

    const rect = container.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';

    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, rect.width, rect.height);

    const maxCount = globalMaxCount || 1;
    const minSize = 16;
    const maxSize = 64;
    const margin = 8;

    const palette = [
      '#1d4ed8',
      '#0f766e',
      '#7c3aed',
      '#be123c',
      '#ea580c',
      '#16a34a'
    ];

    // центр экрана
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;

    // даёт значение чаще около 0, реже ±0.5
    function randCentered() {
      return (Math.random() + Math.random()) / 2 - 0.5; // [-0.5; 0.5]
    }

    // радиус "разлёта" от центра
    const spreadX = rect.width * 0.4;
    const spreadY = rect.height * 0.4;

    drawnWords = [];

    occurrences.forEach(entry => {
      const stats = wordStats[entry.key];
      const text = entry.word;
      const count = stats ? stats.count : 1;

      const size = minSize + (count / maxCount) * (maxSize - minSize);

      ctx.font = `${size}px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif`;
      ctx.textBaseline = 'alphabetic';

      const metrics = ctx.measureText(text);
      const textWidth = metrics.width;
      const textHeight = size;

      // генерируем позицию *вокруг центра*
      let x = centerX + randCentered() * spreadX - textWidth / 2;
      let y = centerY + randCentered() * spreadY + textHeight / 2;

      // жёстко не выпускаем за экран
      if (x < margin) x = margin;
      if (x + textWidth > rect.width - margin) {
        x = rect.width - margin - textWidth;
      }

      if (y - textHeight < margin) {
        y = margin + textHeight;
      }
      if (y > rect.height - margin) {
        y = rect.height - margin;
      }

      ctx.fillStyle = palette[Math.floor(Math.random() * palette.length)];
      ctx.fillText(text, x, y);

      drawnWords.push({
        word: text,
        count,
        x,
        y,
        width: textWidth,
        height: textHeight
      });
    });

    console.log('Нарисовано фраз (включая повторы):', drawnWords.length);
  }

  // ====== ХОВЕР ПО СЛОВАМ ======
  function initWordHover() {
    const container = document.getElementById('wordcloud');
    if (!container) return;

    container.addEventListener('mousemove', (e) => {
      if (!tooltipEl || !drawnWords.length) return;

      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      let hit = null;
      for (let i = drawnWords.length - 1; i >= 0; i--) {
        const w = drawnWords[i];
        if (
          x >= w.x &&
          x <= w.x + w.width &&
          y <= w.y &&
          y >= w.y - w.height
        ) {
          hit = w;
          break;
        }
      }

      if (!hit) {
        tooltipEl.classList.remove('visible');
        return;
      }

      tooltipEl.textContent = `${hit.word} — ${hit.count} раз(а)`;
      tooltipEl.style.left = e.clientX + 'px';
      tooltipEl.style.top = e.clientY + 'px';
      tooltipEl.classList.add('visible');
    });

    container.addEventListener('mouseleave', () => {
      if (tooltipEl) tooltipEl.classList.remove('visible');
    });
  }

  // ====== ИНИЦИАЛИЗАЦИЯ ======
  initQrZoom();
  initWordHover();
  fetchWords();
  setInterval(fetchWords, 10000);

  window.addEventListener('resize', () => {
    renderWordCloud();
  });
</script>

</body>
</html>

