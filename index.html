<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Регистрация — бронирование слотов</title>
  <style>
    :root {
      --bg:#f6f7f9; --card:#fff; --txt:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-contrast:#fff; --ring:0 0 0 3px rgba(37,99,235,.25);
      font-family:system-ui,-apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--txt); -webkit-text-size-adjust:100%}
    .wrap{max-width:960px; margin:24px auto 80px; padding:0 16px}
    @supports(padding:max(0px)){.wrap{padding-left:max(16px,env(safe-area-inset-left)); padding-right:max(16px,env(safe-area-inset-right))}}

    h1{font-size:24px; margin:8px 0 16px; letter-spacing:.2px}
    .card{background:var(--card); border-radius:14px; box-shadow:0 6px 24px rgba(15,23,42,.06); padding:20px}
    fieldset{border:none; padding:0; margin:0 0 18px}
    legend{font-weight:700; margin:0 0 10px}

    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px 16px}
    .row{display:grid; gap:8px}
    .row label{font-size:13px; color:#374151}

    input[type="text"], input[type="tel"], input[type="email"]{
      width:100%; box-sizing:border-box; padding:12px 14px; border:1px solid #d1d5db; border-radius:12px; background:#fff; font-size:15px;
    }
    input:focus{outline:none; box-shadow:var(--ring); border-color:#93c5fd}

    /* Чипы для дат/времени */
    .chips{display:grid; grid-template-columns:repeat(auto-fit, minmax(110px,1fr)); gap:10px}
    label.option{display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:999px; background:#fafafa; cursor:pointer; user-select:none; transition:background .15s,border-color .15s, transform .02s}
    label.option:active{transform:scale(.98)}
    label.option input{appearance:none; width:16px; height:16px; border-radius:50%; border:1.5px solid #9ca3af; display:inline-block}
    label.option input:checked{border-color:var(--accent); box-shadow:inset 0 0 0 4px var(--accent)}
    label.option span{font-weight:600}
    label.option.disabled{opacity:.45; filter:grayscale(100%); cursor:not-allowed}

    .muted{color:var(--muted); font-size:13px; margin-top:6px}

    /* Состав команды: на десктопе 2 в ряд (ФИО + ДР), на мобиле столбиком */
    .members-grid{display:grid; grid-template-columns:1fr 220px; gap:12px 16px; align-items:end}
    .member-row{display:contents}
    .member-name,.member-birth{display:grid; gap:6px}

    @media (max-width:700px){
      .members-grid{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .chips{grid-template-columns:repeat(auto-fit, minmax(90px,1fr))}
    }

    .actions{display:flex; gap:12px; align-items:center; margin-top:14px; flex-wrap:wrap}
    button{appearance:none; border:none; border-radius:12px; padding:12px 16px; font-weight:700; background:var(--accent); color:var(--accent-contrast); cursor:pointer; box-shadow:0 4px 14px rgba(37,99,235,.25)}
    button[disabled]{opacity:.65; cursor:not-allowed}
    button[data-loading="1"]{position:relative}
    button[data-loading="1"]::after{content:""; width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,.6); border-top-color:transparent; display:inline-block; margin-left:8px; vertical-align:-3px; animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.2); display:none; z-index:9999}
    .error{background:#b91c1c}
    .ok{background:#065f46}
    .req{color:#ef4444; margin-left:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Регистрация на мероприятие</h1>
    <div class="card">
      <form id="booking-form" novalidate>
        <!-- 1. Дата участия -->
        <fieldset>
          <legend>1. Дата участия <span class="req">*</span></legend>
          <div id="dateGroup" class="chips">
            <label class="option"><input type="radio" name="event_date" value="2025-11-19" required><span>19 ноября</span></label>
            <label class="option"><input type="radio" name="event_date" value="2025-11-20"><span>20 ноября</span></label>
            <label class="option"><input type="radio" name="event_date" value="2025-11-21"><span>21 ноября</span></label>
          </div>
          <div class="muted">Выберите только одну дату.</div>
        </fieldset>

        <!-- 2. Время проведения -->
        <fieldset>
          <legend>2. Время проведения <span class="req">*</span></legend>
          <div id="timeGroup" class="chips">
            <label class="option"><input type="radio" name="event_time" value="09:00" required><span>09:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="10:00"><span>10:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="11:00"><span>11:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="12:00"><span>12:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="13:00"><span>13:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="14:00"><span>14:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="15:00"><span>15:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="16:00"><span>16:00</span></label>
            <label class="option"><input type="radio" name="event_time" value="17:00"><span>17:00</span></label>
          </div>
          <div class="muted">Слоты, занятые другими участниками, будут недоступны (серым).</div>
        </fieldset>

        <!-- 3. Возрастная категория -->
        <fieldset>
          <legend>3. Возрастная категория <span class="req">*</span></legend>
          <div class="chips" style="grid-template-columns:repeat(auto-fit,minmax(180px,1fr))">
            <label class="option"><input type="radio" name="age_category" value="10-12" required><span>Младшая (10–12)</span></label>
            <label class="option"><input type="radio" name="age_category" value="13-15"><span>Средняя (13–15)</span></label>
            <label class="option"><input type="radio" name="age_category" value="16-18"><span>Старшая (16–18)</span></label>
          </div>
        </fieldset>

        <!-- 4–9. Контакты -->
        <div class="grid">
          <div class="row">
            <label>4. Образовательная организация <span class="req">*</span></label>
            <input type="text" name="org" autocomplete="organization" required />
          </div>
          <div class="row">
            <label>5. ФИО руководителя <span class="req">*</span></label>
            <input type="text" name="leader_name" autocomplete="name" required />
          </div>
          <div class="row">
            <label>6. Должность <span class="req">*</span></label>
            <input type="text" name="position" autocomplete="organization-title" required />
          </div>
          <div class="row">
            <label>7. Контактный номер телефона <span class="req">*</span></label>
            <input type="tel" name="phone" inputmode="tel" autocomplete="tel" placeholder="+7 900 000-00-00" required />
          </div>
          <div class="row">
            <label>8. Адрес электронной почты <span class="req">*</span></label>
            <input type="email" name="email" autocomplete="email" placeholder="name@example.com" required />
          </div>
          <div class="row">
            <label>9. Название команды <span class="req">*</span></label>
            <input type="text" name="team_name" required />
          </div>
        </div>

        <!-- 10–15. Состав команды (ручной ввод даты ДД.ММ.ГГГГ) -->
        <fieldset>
          <legend>10–15. Состав команды <span class="req">*</span></legend>
          <div class="members-grid">
            <div class="member-row">
              <div class="member-name"><label>10. ФИО участника 1</label><input type="text" name="member1_name" required /></div>
              <div class="member-birth"><label>11. Дата рождения участника 1</label><input type="text" class="date-ru" name="member1_birth" placeholder="ДД.ММ.ГГГГ" inputmode="numeric" autocomplete="bday" required /></div>
            </div>
            <div class="member-row">
              <div class="member-name"><label>12. ФИО участника 2</label><input type="text" name="member2_name" required /></div>
              <div class="member-birth"><label>13. Дата рождения участника 2</label><input type="text" class="date-ru" name="member2_birth" placeholder="ДД.ММ.ГГГГ" inputmode="numeric" autocomplete="bday" required /></div>
            </div>
            <div class="member-row">
              <div class="member-name"><label>14. ФИО участника 3</label><input type="text" name="member3_name" required /></div>
              <div class="member-birth"><label>15. Дата рождения участника 3</label><input type="text" class="date-ru" name="member3_birth" placeholder="ДД.ММ.ГГГГ" inputmode="numeric" autocomplete="bday" required /></div>
            </div>
          </div>
          <div class="muted">Можно печатать дату напрямую: формат <b>ДД.ММ.ГГГГ</b>. Мы проверим корректность и преобразуем автоматически.</div>
        </fieldset>

        <div class="actions">
          <button id="submitBtn" type="submit">Отправить заявку</button>
          <span id="hint" class="muted">Все поля обязательны. При гонке за слот система сообщит, если время уже занято.</span>
        </div>
      </form>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === ВСТАВЬТЕ СВОИ ЗНАЧЕНИЯ ===
const SUPABASE_URL = "https://wjoldaptaecqfworfkzk.supabase.co"; // твой Project URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqb2xkYXB0YWVjcWZ3b3Jma3prIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNzQ0OTEsImV4cCI6MjA3Nzk1MDQ5MX0.-sQLLELT8xq_xYX1INTZE_Q2bzoxEOEoPwcSotIKryE";                // TODO (public anon)

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const TIMES = ['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
    const form = document.getElementById('booking-form');
    const submitBtn = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');

    function showToast(msg, ok=false){
      toast.textContent = msg;
      toast.className = 'toast ' + (ok ? 'ok' : 'error');
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display = 'none', 3500);
    }

    // --- Маска и парсинг ДД.ММ.ГГГГ ---
    function maskDateInput(el){
      let v = (el.value||'').replace(/\\D/g,'').slice(0,8);
      if (v.length >= 5) v = v.slice(0,2)+'.'+v.slice(2,4)+'.'+v.slice(4);
      else if (v.length >= 3) v = v.slice(0,2)+'.'+v.slice(2);
      el.value = v;
    }
    function parseRusDate(s){
      const m = /^(\\d{2})\\.(\\d{2})\\.(\\d{4})$/.exec(s||'');
      if (!m) return null;
      const d = parseInt(m[1],10), mo = parseInt(m[2],10), y = parseInt(m[3],10);
      const dt = new Date(y, mo-1, d);
      if (dt.getFullYear()!==y || (dt.getMonth()+1)!==mo || dt.getDate()!==d) return null;
      return dt;
    }
    function toISODate(dt){
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return y+'-'+m+'-'+d;
    }
    document.querySelectorAll('input.date-ru').forEach(el=>{
      el.addEventListener('input', ()=> maskDateInput(el), {passive:true});
      el.addEventListener('blur', ()=>{
        const ok = !!parseRusDate(el.value);
        el.setCustomValidity(ok ? '' : 'Введите дату в формате ДД.ММ.ГГГГ');
      });
    });

    function getSelectedDate(){
      const el = document.querySelector('input[name="event_date"]:checked');
      return el ? el.value : null;
    }
    function setTimeDisabled(time, disabled){
      const input = document.querySelector('input[name="event_time"][value="'+time+'"]');
      if (!input) return;
      input.disabled = !!disabled;
      const lbl = input.closest('label.option');
      if (lbl) lbl.classList.toggle('disabled', !!disabled);
      if (disabled && input.checked) input.checked = false;
    }

    async function refreshDisabledTimes(){
      const date = getSelectedDate();
      if (!date) return;
      TIMES.forEach(t => setTimeDisabled(t, false));
      const { data, error } = await supabase
        .from('booked_slots').select('event_time').eq('event_date', date);
      if (error) { console.error(error); return; }
      const booked = new Set((data||[]).map(r => (r.event_time||'').slice(0,5)));
      TIMES.forEach(t => { if (booked.has(t)) setTimeDisabled(t, true); });
    }
    document.getElementById('dateGroup').addEventListener('change', refreshDisabledTimes, { passive:true });

    (function initDefaultDate(){
      const first = document.querySelector('input[name="event_date"]');
      if (first && !document.querySelector('input[name="event_date"]:checked')) first.checked = true;
      refreshDisabledTimes();
    })();

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!form.reportValidity()) return;
      submitBtn.disabled = true; submitBtn.dataset.loading = '1';

      // Преобразуем даты рождения в ISO
      const b1 = parseRusDate(form.member1_birth.value);
      const b2 = parseRusDate(form.member2_birth.value);
      const b3 = parseRusDate(form.member3_birth.value);
      if (!b1 || !b2 || !b3){
        showToast('Проверьте даты рождения (ДД.ММ.ГГГГ).', false);
        submitBtn.disabled = false; submitBtn.dataset.loading = '0';
        return;
      }

      const fd = new FormData(form);
      const payload = {
        event_date: fd.get('event_date'),
        event_time: fd.get('event_time'),
        age_category: fd.get('age_category'),
        org: (fd.get('org')||'').trim(),
        leader_name: (fd.get('leader_name')||'').trim(),
        position: (fd.get('position')||'').trim(),
        phone: (fd.get('phone')||'').trim(),
        email: (fd.get('email')||'').trim(),
        team_name: (fd.get('team_name')||'').trim(),
        member1_name: (fd.get('member1_name')||'').trim(),
        member1_birth: toISODate(b1),
        member2_name: (fd.get('member2_name')||'').trim(),
        member2_birth: toISODate(b2),
        member3_name: (fd.get('member3_name')||'').trim(),
        member3_birth: toISODate(b3),
      };

      // Health-check: проект не «усыплён»
      const { error: pingErr } = await supabase
        .from('booked_slots')
        .select('event_time', { count: 'exact', head: true });
      if (pingErr){
        showToast('Сервис временно недоступен. Повторите позже.', false);
        submitBtn.disabled = false; submitBtn.dataset.loading = '0';
        return;
      }

      const { error } = await supabase.from('bookings').insert(payload);
      if (error){
        if (error.code === '23505'){
          showToast('Этот слот уже занят. Выберите другое время.', false);
          await refreshDisabledTimes();
        } else {
          console.error(error);
          showToast('Ошибка отправки: ' + (error.message || 'попробуйте позже.'), false);
        }
        submitBtn.disabled = false; submitBtn.dataset.loading = '0';
        return;
      }

      showToast('Заявка принята! Мы свяжемся с вами по e-mail.', true);
      form.reset();
      refreshDisabledTimes();
      submitBtn.disabled = false; submitBtn.dataset.loading = '0';
    });
  </script>
</body>
</html>
